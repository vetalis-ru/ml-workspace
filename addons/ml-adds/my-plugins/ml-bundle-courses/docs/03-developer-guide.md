# Для разработчика (v0.2.0)

## Точка интеграции
Основной триггер — событие выдачи сертификата:
- hook: `mbl_certificate_issued($user_id, $cert_id)`

Внутри обработчика:
- извлекается сертификат по `$cert_id`
- определяется `term_id` текущего курса
- вычисляется следующий шаг программы
- выдаётся следующий УД через каноничные функции MemberLux

## Каноничная выдача доступа (MemberLux)
Выдача следующего шага выполняется строго через:
- `wpm_insert_one_user_key($term_id, $duration, $units, $is_unlimited=false)`
- `wpm_update_user_key_dates($user_id, $code, $isBanned=false, $source='program_flow')`

Это гарантирует запуск стандартных side-effects MemberLux (hook `wpm_update_user_key_dates` и внутренние обновления ключей/мета).

## Основной обработчик
Ключевая логика находится в:
- `MLP_Certificate_Hook::handle(...)`

Типовой pipeline:
1) проверка идемпотентности
2) определение текущего шага
3) выдача следующего УД
4) уведомления
5) запись прогресса

## Расширяемость
После успешной выдачи шага вызывается action:
- `mlp_program_step_granted`

Его можно использовать для дополнительной интеграции (webhook, аналитика, CRM и т.п.).
