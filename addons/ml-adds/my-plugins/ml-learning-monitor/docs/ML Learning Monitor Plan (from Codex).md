План ML Learning Monitor (от Codex)

Phase 1 — Baseline / аудит текущего UI + query
Цель: подтвердить текущую базу, не менять UX.
Что делаем:
Зафиксировать текущий UX (терм-UI, вкладки, кнопка “сонь”, AJAX).
Аудит безопасности: nonce, cap checks, sanitization, escaping (сейчас базово есть).
Аудит SQL/логики “сонь” (внутри query_sleepers) на предмет критериев и потенциальных N+1. Пока выборка вшита в основной файл.
✅ Выход фазы: подтверждённый baseline + список улучшений без функционального изменения.
 
Phase 2 — Корректная бизнес-логика “сонь”
Цель: опеделить канонический критерий “соня”.
Что делаем:
Добавить проверку: истёкший УД + нет ручного сертификата + нет активного продления (сейчас только истёкший/нет активного ключа).
Подготовить hooks/изолированные методы для проверки сертификатов и продлений (без вмешательства в core).
✅ Выход фазы: корректный критерий “сонь”, без отправки писем.
 
Phase 3 — Cron-логика (dry-run → реальные письма)
Цель: безопасный cron и идемпотентность.
Что делаем:
Ввести хранение истории уведомлений (user_id + term_id + step).
Dry-run cron (логирование без писем), затем включение отправки.
Остановка цепочки при продлении или ручном сертификате.
 
Phase 4 — Email-рендеринг/шорткоды
Цель: шаблоны писем и токены.
Что делаем:
Реализация шаблонизатора (подстановки {{user_email}}, {{course_name}}, {{expired_date}}, и т.д.).
Связь с ML mail-процессом через безопасный helper.
 
Phase 5 — Техническое усиление
Цель: стабильность и читаемость.
Что делаем:
Разнести код по классам (UI / storage / query / ajax / logger).
Опционально добавить WP_List_Table для “сонь” (если нужно).
Добавить admin notices для UX (если решим делать).

