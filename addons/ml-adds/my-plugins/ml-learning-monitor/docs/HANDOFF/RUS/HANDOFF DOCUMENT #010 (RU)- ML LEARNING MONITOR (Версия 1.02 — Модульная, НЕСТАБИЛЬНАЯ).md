Тип: Кастомный плагин-надстройка (Рефакторинг, Сырая версия)
Статус: Нестабильный, содержит известные баги и требует доработки.
Зависимости: WordPress, MemberLux Core (таблица memberlux_term_keys), MBL Certificates (таблица memberlux_certificate для корректной работы).
Назначение: Мониторинг "сонь" с расширенным, но багным функционалом: проверка сертификатов, сортировка таблицы. Архитектура переработана с монолитной на модульную, но код запутан и не оптимизирован.

1. ФАЙЛОВАЯ АРХИТЕКТУРА (МОДУЛЬНАЯ, С ПУТАНИЦЕЙ)
text
ml-learning-monitor/
├── ml-learning-monitor.php              # Бутстрап. Подключает классы (версия 1.02)
├── includes/
│   ├── class-mlm-core.php              # Фасад, инициализация, хуки
│   ├── class-mlm-assets.php            # Подключение JS/CSS (используется)
│   ├── class-mlm-term-fields.php       # Рендер и сохранение главного UI (используется)
│   ├── class-mlm-email-fields.php      # Рендер и сохранение полей писем (используется)
│   ├── class-mlm-ajax-handler.php      # Обработчик AJAX `mlm_get_sleepers` (используется)
│   ├── class-mlm-database.php          # SQL-запросы с JOIN на сертификаты (используется)
│   └── class-mlm-renderer.php          # Генерация HTML таблицы с сортировкой (используется)
├── assets/
│   ├── mlm-admin.js                    # Фронтенд-логика v1.02 (работает с формами)
│   └── mlm-admin.css                   # Стили (аналогично v1.01)
└── (НЕ ИСПОЛЬЗУЕТСЯ в данной сборке:)
    └── trait-mlm-admin-ui.php          # ТРЕЙТ-АРТЕФАКТ. Альтернативная, неиспользуемая реализация UI. Содержит дублирующие методы.
2. КЛЮЧЕВЫЕ ИЗМЕНЕНИЯ И НОВЫЕ БАГИ (ОТНОСИТЕЛЬНО 1.01)
Функционал	Версия 1.01 (Монолит)	Версия 1.02 (Модульная)	Проблемы / Баги в 1.02
Архитектура	Один класс (ML_Learning_Monitor)	7 классов + фасад. Принцип SRP.	Код запутан. Есть неиспользуемый трейт-артефакт.
Проверка сертификатов	❌ Не проверяет	✅ JOIN на memberlux_certificate	Логика не проверена. Возможны ошибки из-за некорректного условия c.certificate_id IS NULL.
Сортировка таблицы	❌ Нет	✅ Кликабельные заголовки, параметры sort/order	БАГ: Сортировка по некоторым полям (например, "Последняя выдача УД") не работает или работает некорректно (не переключается ASC/DESC). JS не обрабатывает клики по новым заголовкам от MLM_Renderer.
SQL-запрос	Базовый, без status и проверки дат	Усложнен: status='expired', проверка date_end!='0000-00-00'.	Ненадежность: Добавлены условия, но их корректность не гарантирована. Использование status='expired' может не соответствовать данным в memberlux_term_keys.
Выдача "сонь"	Без фильтров	С фильтрами и пагинацией	Результаты могут быть некорректны. Общая уверенность в выборке низкая.
3. КЛАССЫ И ИХ РОЛИ (ИСПОЛЬЗУЕМАЯ СБОРКА)
ML_Learning_Monitor (Core)

Константы: TAXONOMY, NONCE_ACTION, PER_PAGE=20.

Роль: Фасад. Инициализирует компоненты и регистрирует хуки в __construct.

MLM_Assets

Метод: enqueue($hook). Подключает скрипты/стили только на term.php?taxonomy=wpm-levels.

Локализация: Передает ajaxUrl, nonce, perPage в JS объект MLM.

MLM_Term_Fields

Методы: render($term), save($term_id, $tt_id).

Роль: Рендерит чекбокс включения, контейнер с вкладками, блок "сонь". Сохраняет mlm_enabled и делегирует сохранение полей писем классу MLM_Email_Fields.

MLM_Email_Fields

Методы: render_student(), render_admin(), save_student_fields(), save_admin_fields().

Роль: Работа с полями писем (days, subject, body). Отображает шорткоды (замена не реализована).

MLM_Ajax_Handler

Метод: get_sleepers().

Роль: Валидация, безопасность, вызов MLM_Database и MLM_Renderer. Добавлены параметры $sort, $order (новое в 1.02).

MLM_Database (Наиболее измененный класс)

Метод: query_sleepers($term_id, $page, $per_page, $date_from, $date_to, $sort='user_id', $order='DESC').

Ключевые изменения (и потенциальные баги):

JOIN на memberlux_certificate: LEFT JOIN ... ON c.user_id = k.user_id AND c.wpmlevel_id = k.term_id. Условие c.certificate_id IS NULL исключает пользователей с сертификатами.

Проверка статуса: AND k.status = 'expired' — опасное допущение. В memberlux_term_keys статус может быть USED, NEW, но не expired. Это вероятная ошибка.

Проверка дат: Добавлены условия AND k.date_end != '0000-00-00' и AND k.date_end <= %s (с current_time).

Сортировка: Реализована через белый список полей ($allowed_sort). Но может не работать из-за сложного подзапроса s.

MLM_Renderer (С новым багным функционалом)

Метод: render_sleepers_table(..., $sort, $order).

Новое: Генерирует заголовки таблицы с помощью render_sortable_header(), делая их кликабельными (<a href="#" class="mlm-sort" data-sort="..." data-order="...">).

БАГ: Сгенерированные ссылки для сортировки не имеют работающего JS-обработчика. В mlm-admin.js есть заготовка ($(document).on("click", ".mlm-sort", ...)), но логика может быть несвязана с новым HTML или содержать ошибки. Сортировка по клику на заголовок не работает.

4. ИЗВЕСТНЫЕ БАГИ И ПРОБЛЕМЫ (ТРЕБУЕТСЯ ИСПРАВЛЕНИЕ)
Сортировка таблицы: Неработающая. Клик на заголовки (mlm-sort) не меняет порядок. Причины: JS не обрабатывает события, или параметры sort/order некорректно передаются в AJAX.

SQL-условие status='expired': Критическая логическая ошибка. В таблице memberlux_term_keys нет статуса expired. Доступ считается истекшим по дате (date_end). Это условие обнулит выборку.

Проверка сертификатов: Логика c.certificate_id IS NULL может быть неверной, если связь wpmlevel_id (в сертификате) и term_id (в ключе) неоднозначна. Требуется проверка.

Дублирование кода / Артефакты: Наличие неиспользуемого трейта MLM_Admin_UI свидетельствует о грязном рефакторинге и запутанности кодовой базы.

Общая надежность: Нет уверенности, что запрос выдает корректных "сонь". Требуется тщательное тестирование с различными данными.

Отсутствие оптимизации: Запросы сложные, с несколькими подзапросами и JOIN. Нет индексов, нет кэширования.

5. WORDPRESS HOOKS (Аналогично 1.01, но зарегистрированы через Core)
php
// Регистрация в ML_Learning_Monitor::setup_hooks()
add_action('wpm-levels_edit_form_fields', [$this->term_fields, 'render'], 20, 1);
add_action('edited_wpm-levels', [$this->term_fields, 'save'], 20, 2);
add_action('admin_enqueue_scripts', [$this->assets, 'enqueue']);
add_action('wp_ajax_mlm_get_sleepers', [$this->ajax_handler, 'get_sleepers']);
6. РЕКОМЕНДАЦИИ ДЛЯ ДАЛЬНЕЙШЕЙ РАЗРАБОТКИ
Исправить status='expired': Заменить на корректную проверку: AND k.date_end IS NOT NULL AND k.date_end <= CURRENT_DATE().

Починить сортировку:

Проверить JS-обработчик событий .mlm-sort.

Убедиться, что параметры sort и order доходят до MLM_Database::query_sleepers() и правильно применяются в SQL ORDER BY.

Верифицировать проверку сертификатов: Написать unit-тест или выполнить ручные проверки, что JOIN корректно исключает пользователей с выданными сертификатами.

Удалить мертвый код: Убрать трейт MLM_Admin_UI и другие артефакты.

Оптимизировать запрос: Проанализировать EXPLAIN запроса, добавить индексы на memberlux_term_keys(term_id, date_end, user_id, is_banned).

Добавить логирование: Внести запись в лог при выполнении AJAX-запроса для отладки ошибок.

Тестирование Phase 2: Перед переходом к Phase 3 (Cron) необходимо добиться стабильной работы Phase 2 (корректная бизнес-логика "сонь").

ВЫВОД: Версия 1.02 — сырая и нестабильная. Она представляет собой попытку рефакторинга и добавления нового функционала, но содержит критические баги, мешающие ее использованию. Это не production-ready код, а этап разработки, требующий значительных доработок и отладки.